---
phase: 09-auth-migration
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/auth/[...nextauth]/route.ts
  - src/middleware.ts
  - src/lib/auth-helpers.ts
autonomous: false

must_haves:
  truths:
    - "Login works on localhost:3000"
    - "Login works on 127.0.0.1:3000"
    - "Login works on LAN IP address"
    - "Protected routes redirect to /login when not authenticated"
    - "Session persists across page refresh"
    - "Logout clears session"
  artifacts:
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth API handler"
      min_lines: 2
    - path: "src/middleware.ts"
      provides: "Route protection using auth config"
      contains: "auth.config"
    - path: "src/lib/auth-helpers.ts"
      provides: "Auth utility functions using auth()"
      contains: "import { auth }"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/auth.config.ts"
      via: "NextAuth instantiation"
      pattern: "import authConfig"
    - from: "src/lib/auth-helpers.ts"
      to: "src/lib/auth.ts"
      via: "auth function import"
      pattern: "import { auth } from"
    - from: "src/app/api/auth/[...nextauth]/route.ts"
      to: "src/lib/auth.ts"
      via: "handlers export"
      pattern: "import { handlers }"
---

<objective>
Update all integration points to use new Auth.js v5 exports and verify authentication works.

Purpose: Complete migration by updating API route, middleware, and helpers
Output: Fully functional Auth.js v5 authentication across all URLs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-auth-migration/09-01-SUMMARY.md

# Updated files from Plan 01:
@src/lib/auth.config.ts
@src/lib/auth.ts
@src/types/next-auth.d.ts

# Files to update:
@src/app/api/auth/[...nextauth]/route.ts
@src/middleware.ts
@src/lib/auth-helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify API route to handlers export</name>
  <files>src/app/api/auth/[...nextauth]/route.ts</files>
  <action>
    Replace the current API route with a simple re-export of handlers:

    BEFORE:
    ```typescript
    import NextAuth from 'next-auth'
    import { authOptions } from '@/lib/auth'

    const handler = NextAuth(authOptions)

    export { handler as GET, handler as POST }
    ```

    AFTER:
    ```typescript
    import { handlers } from '@/lib/auth'

    export const { GET, POST } = handlers
    ```

    This is now a 2-line file. All configuration lives in auth.ts.
  </action>
  <verify>
    - File is exactly 3 lines (import + blank + export)
    - No reference to `authOptions`
    - No instantiation of NextAuth in this file
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>API route simplified to handlers re-export</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite middleware for v5</name>
  <files>src/middleware.ts</files>
  <action>
    Replace middleware with v5 pattern using edge-compatible auth.config:

    BEFORE:
    ```typescript
    import { withAuth } from 'next-auth/middleware'
    import { NextResponse } from 'next/server'

    export default withAuth(
      function middleware(req) {
        return NextResponse.next()
      },
      {
        callbacks: {
          authorized: ({ token }) => !!token,
        },
        pages: {
          signIn: '/login',
        },
      }
    )
    ```

    AFTER:
    ```typescript
    import NextAuth from 'next-auth'
    import authConfig from '@/lib/auth.config'

    // Use edge-compatible config (no database adapter)
    const { auth } = NextAuth(authConfig)

    export default auth

    export const config = {
      matcher: [
        /*
         * Match all request paths except:
         * - /login, /signup (auth pages)
         * - /api (API routes handle their own auth)
         * - /_next (Next.js internals)
         * - /favicon.ico, /manifest.json, etc. (static files)
         */
        '/((?!login|signup|api|_next/static|_next/image|favicon.ico|manifest.json|icons).*)',
      ],
    }
    ```

    Key changes:
    - No more `withAuth` wrapper (removed in v5)
    - Import `authConfig` (edge-compatible, no db)
    - Create new NextAuth instance with edge config
    - Export `auth` directly as middleware
    - Route protection handled by `callbacks.authorized` in auth.config.ts
    - Matcher config stays the same
  </action>
  <verify>
    - No import of `withAuth`
    - Imports `authConfig` from '@/lib/auth.config'
    - Exports `auth` as default
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Middleware rewritten with v5 pattern</done>
</task>

<task type="auto">
  <name>Task 3: Update auth-helpers to use auth()</name>
  <files>src/lib/auth-helpers.ts</files>
  <action>
    Replace getServerSession with auth():

    BEFORE:
    ```typescript
    import { getServerSession } from 'next-auth'
    import { authOptions } from './auth'
    import { AuthUser } from '@/types'

    export async function getCurrentUser(): Promise<AuthUser | null> {
      const session = await getServerSession(authOptions)
      // ...
    }
    ```

    AFTER:
    ```typescript
    import { auth } from './auth'
    import { AuthUser } from '@/types'

    export async function getCurrentUser(): Promise<AuthUser | null> {
      const session = await auth()
      // ...
    }
    ```

    Key changes:
    - Import `auth` instead of `getServerSession` and `authOptions`
    - Call `auth()` with no arguments (not `getServerSession(authOptions)`)
    - Rest of the function logic stays identical

    The `requireAuth()` and `isAuthenticated()` functions don't need changes
    because they call `getCurrentUser()` internally.
  </action>
  <verify>
    - No import of `getServerSession`
    - No import of `authOptions`
    - Imports `auth` from './auth'
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>auth-helpers updated to use auth()</done>
</task>

<task type="auto">
  <name>Task 4: Build and type check</name>
  <files>N/A</files>
  <action>
    Run full TypeScript build to verify all changes work together:

    1. Run `npx tsc --noEmit` for type checking
    2. Run `npm run build` for full Next.js build
    3. Fix any type errors that emerge

    Common issues to check:
    - No "Module not found" errors for next-auth imports
    - No "getServerSession is not exported" errors
    - No "withAuth is not exported" errors
    - Session types have id and email properties
  </action>
  <verify>
    - `npx tsc --noEmit` exits with code 0
    - `npm run build` completes successfully
    - No TypeScript errors related to auth
  </verify>
  <done>TypeScript and Next.js build both pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Auth.js v5 migration with trustHost support</what-built>
  <how-to-verify>
    Test authentication on multiple URLs to verify trustHost works:

    1. Start dev server: `npm run dev`

    2. Test localhost login:
       - Visit: http://localhost:3000
       - Should redirect to /login
       - Log in with your credentials
       - Should redirect to /vandaag
       - Refresh page - session should persist

    3. Test 127.0.0.1 login:
       - Open new incognito window
       - Visit: http://127.0.0.1:3000
       - Log in with same credentials
       - Should work without config changes

    4. Test LAN IP login (optional but recommended):
       - Find your LAN IP: `hostname -I` (Linux) or `ipconfig` (Windows)
       - Open new incognito window
       - Visit: http://YOUR_LAN_IP:3000
       - Log in with same credentials
       - Should work without config changes

    5. Test logout:
       - Click logout / go to /api/auth/signout
       - Session should be cleared
       - Should redirect to /login

    6. Test protected route:
       - Clear all cookies
       - Visit http://localhost:3000/vandaag directly
       - Should redirect to /login

    Note: Users will be logged out after this migration (cookie name changed).
    This is expected and documented.
  </how-to-verify>
  <resume-signal>Type "approved" if auth works on all URLs, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] API route is 2-3 lines (handlers re-export)
- [ ] Middleware uses auth.config.ts
- [ ] auth-helpers.ts uses auth() function
- [ ] `npm run build` passes
- [ ] Login works on localhost:3000
- [ ] Login works on 127.0.0.1:3000
- [ ] Protected routes redirect when not authenticated
- [ ] Session persists across refresh
</verification>

<success_criteria>
- All integration points updated to v5 pattern
- TypeScript and Next.js build pass
- Authentication works on localhost
- Authentication works on 127.0.0.1
- Authentication works on LAN IP (if tested)
- Protected routes properly redirect
- Session management works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-migration/09-02-SUMMARY.md`
</output>
