---
phase: 09-auth-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/auth.config.ts
  - src/lib/auth.ts
  - src/types/next-auth.d.ts
  - .env.production.example
autonomous: true

must_haves:
  truths:
    - "next-auth@beta (v5) is installed"
    - "Auth config exports handlers, auth, signIn, signOut"
    - "TypeScript compiles without errors"
  artifacts:
    - path: "src/lib/auth.config.ts"
      provides: "Edge-compatible auth config for middleware"
      contains: "NextAuthConfig"
    - path: "src/lib/auth.ts"
      provides: "Full auth config with credentials provider"
      exports: ["handlers", "auth", "signIn", "signOut"]
    - path: "src/types/next-auth.d.ts"
      provides: "v5-compatible type augmentation"
      contains: "DefaultSession"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/auth.config.ts"
      via: "spread operator import"
      pattern: "import authConfig from"
---

<objective>
Install Auth.js v5 and create new configuration files with trustHost support.

Purpose: Foundation for Auth.js v5 migration â€” package upgrade and config rewrite
Output: Working auth configuration files ready for integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md

# Existing auth implementation:
@src/lib/auth.ts
@src/lib/auth-helpers.ts
@src/lib/ip-utils.ts
@src/middleware.ts
@src/types/next-auth.d.ts
@src/app/api/auth/[...nextauth]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade to next-auth@beta</name>
  <files>package.json</files>
  <action>
    1. Run: `npm uninstall next-auth && npm install next-auth@beta`
    2. Verify package.json shows next-auth version 5.x.x-beta.x

    Note: v5 is still in beta (as of Jan 2026). This is expected.
  </action>
  <verify>
    - `cat package.json | grep next-auth` shows version starting with "5." or "^5."
    - `npm ls next-auth` confirms installed version
  </verify>
  <done>next-auth@5.x.x-beta.x installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create edge-compatible auth.config.ts</name>
  <files>src/lib/auth.config.ts</files>
  <action>
    Create new file `src/lib/auth.config.ts` with edge-compatible configuration:

    - Import `NextAuthConfig` type from 'next-auth'
    - Import `Credentials` from 'next-auth/providers/credentials'
    - Export default config object satisfying `NextAuthConfig`
    - Configure trustHost: true (core v1.2 feature)
    - Define pages: { signIn: '/login', error: '/login' }
    - Define callbacks.jwt and callbacks.session (same logic as current)
    - Define callbacks.authorized for middleware route protection
    - Do NOT include authorize function (requires database, not edge-compatible)

    Key trustHost benefit: Enables dynamic URL detection from Host header.

    ```typescript
    import type { NextAuthConfig } from 'next-auth'
    import Credentials from 'next-auth/providers/credentials'

    export default {
      trustHost: true,  // KEY: Dynamic URL detection
      providers: [
        Credentials({
          name: 'credentials',
          credentials: {
            email: { label: 'Email', type: 'email' },
            password: { label: 'Password', type: 'password' },
          },
          // authorize NOT defined here - in auth.ts (requires db)
        }),
      ],
      pages: {
        signIn: '/login',
        error: '/login',
      },
      session: {
        strategy: 'jwt',
        maxAge: 30 * 24 * 60 * 60, // 30 days
      },
      callbacks: {
        async jwt({ token, user }) {
          if (user) {
            token.id = user.id
            token.email = user.email
          }
          return token
        },
        async session({ session, token }) {
          if (token && session.user) {
            session.user.id = token.id as string
            session.user.email = token.email as string
          }
          return session
        },
        authorized({ auth, request: { nextUrl } }) {
          const isLoggedIn = !!auth?.user
          const publicPaths = ['/login', '/signup']
          const isPublicPath = publicPaths.some(path =>
            nextUrl.pathname.startsWith(path)
          )

          if (!isLoggedIn && !isPublicPath) {
            return false // Redirect to signIn
          }
          return true
        },
      },
    } satisfies NextAuthConfig
    ```
  </action>
  <verify>
    - File exists at src/lib/auth.config.ts
    - Contains `trustHost: true`
    - TypeScript compiles: `npx tsc --noEmit src/lib/auth.config.ts`
  </verify>
  <done>Edge-compatible auth.config.ts created with trustHost: true</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite auth.ts with v5 export pattern</name>
  <files>src/lib/auth.ts</files>
  <action>
    Rewrite `src/lib/auth.ts` with Auth.js v5 pattern:

    1. Import NextAuth default export (not NextAuthOptions type)
    2. Import authConfig from './auth.config'
    3. Import Credentials provider
    4. Keep all existing imports (bcrypt, prisma, rate-limit, ip-utils)
    5. Export { handlers, auth, signIn, signOut } from NextAuth({...})
    6. Spread authConfig and override providers with authorize function
    7. Update authorize signature: `(credentials, request)` instead of `(credentials, req)`
    8. Update request header access: `request?.headers?.get('x-forwarded-for')` instead of `req?.headers?.['x-forwarded-for']`
    9. Remove `secret: process.env.NEXTAUTH_SECRET` (v5 auto-detects AUTH_SECRET)

    Key changes in authorize callback:
    - Second parameter renamed from `req` to `request`
    - Request is now standard `Request` type (not IncomingMessage)
    - Access headers via `request.headers.get()` not `request.headers[]`

    Update getClientIp call to work with Request object:
    ```typescript
    const clientIp = getClientIp(request)
    const userAgent = request?.headers?.get('user-agent') ?? undefined
    ```

    The getClientIp function in ip-utils.ts already supports both Header types (has get() method check).

    Preserve ALL existing rate limiting logic. Only change the request access pattern.
  </action>
  <verify>
    - File exports { handlers, auth, signIn, signOut }
    - No `authOptions` export (removed)
    - No `NextAuthOptions` type import
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>auth.ts rewritten with v5 export pattern (handlers, auth, signIn, signOut)</done>
</task>

<task type="auto">
  <name>Task 4: Update TypeScript type declarations</name>
  <files>src/types/next-auth.d.ts</files>
  <action>
    Update type declarations to v5 pattern:

    1. Import DefaultSession and DefaultUser from 'next-auth'
    2. Import DefaultJWT from 'next-auth/jwt'
    3. Extend default types instead of replacing

    ```typescript
    import { DefaultSession, DefaultUser } from 'next-auth'
    import { DefaultJWT } from 'next-auth/jwt'

    declare module 'next-auth' {
      interface Session {
        user: {
          id: string
          email: string
        } & DefaultSession['user']
      }

      interface User extends DefaultUser {
        id: string
        email: string
      }
    }

    declare module 'next-auth/jwt' {
      interface JWT extends DefaultJWT {
        id: string
        email: string
      }
    }
    ```
  </action>
  <verify>
    - TypeScript compiles without type errors
    - Session.user has id and email properties
  </verify>
  <done>Type declarations updated for v5 compatibility</done>
</task>

<task type="auto">
  <name>Task 5: Update environment variable documentation</name>
  <files>.env.production.example</files>
  <action>
    Update .env.production.example:

    1. Rename NEXTAUTH_SECRET to AUTH_SECRET in comments and example
    2. Remove NEXTAUTH_URL section (no longer needed with trustHost)
    3. Add AUTH_TRUST_HOST=true as required setting
    4. Update comments to reflect v5 behavior

    New environment section:
    ```
    # ============================================
    # REQUIRED: Auth.js Secret
    # ============================================
    # Secret for JWT signing - MUST be at least 32 characters
    # Generate with: openssl rand -base64 32
    AUTH_SECRET=change_me_to_a_random_string_at_least_32_chars

    # ============================================
    # REQUIRED: Trust Host (for self-hosting)
    # ============================================
    # Enables dynamic URL detection from Host header
    # Required for login to work on localhost, IP, and domain
    AUTH_TRUST_HOST=true

    # Note: AUTH_URL is NOT needed - v5 auto-detects from request
    # Only set AUTH_URL if you need to force a specific domain
    ```

    Keep backward compatibility note: "NEXTAUTH_SECRET also works as alias for AUTH_SECRET"
  </action>
  <verify>
    - File contains AUTH_SECRET and AUTH_TRUST_HOST
    - No required NEXTAUTH_URL setting
    - Comments explain v5 trustHost behavior
  </verify>
  <done>Environment documentation updated for Auth.js v5</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm ls next-auth` shows v5.x.x-beta.x
- [ ] `npx tsc --noEmit` passes without errors
- [ ] src/lib/auth.config.ts exists with trustHost: true
- [ ] src/lib/auth.ts exports handlers, auth, signIn, signOut
- [ ] No import of `NextAuthOptions` or `getServerSession` in auth.ts
</verification>

<success_criteria>
- next-auth@beta installed
- auth.config.ts created with edge-compatible config
- auth.ts rewritten with v5 export pattern
- Type declarations updated for v5
- Environment docs updated
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-migration/09-01-SUMMARY.md`
</output>
