---
phase: 04-celebrations-and-streaks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(main)/vandaag/page.tsx
  - src/lib/hooks.ts
autonomous: true

must_haves:
  truths:
    - "User sees large confetti explosion when completing the last remaining task"
    - "Confetti explosion happens once per transition to all-complete"
    - "Haptic feedback accompanies the celebration"
  artifacts:
    - path: "src/lib/hooks.ts"
      provides: "usePrevious hook for tracking state changes"
      min_lines: 10
      exports: ["usePrevious"]
    - path: "src/app/(main)/vandaag/page.tsx"
      provides: "All-tasks celebration trigger logic"
      contains: "fireAllTasksConfetti"
  key_links:
    - from: "vandaag/page.tsx"
      to: "usePrevious hook"
      via: "Track previous completedCount"
      pattern: "usePrevious.*completedCount"
    - from: "vandaag/page.tsx"
      to: "fireAllTasksConfetti"
      via: "useEffect on justCompletedAll"
      pattern: "fireAllTasksConfetti\\(\\)"
    - from: "vandaag/page.tsx"
      to: "triggerHaptic"
      via: "useEffect on justCompletedAll"
      pattern: "triggerHaptic\\('success'\\)"
---

<objective>
Implement all-tasks-done celebration that fires when user completes the last remaining task for the day.

Purpose: Create a milestone moment when all daily tasks are complete - larger celebration than single task completion, using the fireAllTasksConfetti preset built in Phase 3.
Output: Large confetti explosion + haptic feedback when transitioning from incomplete to all-complete state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 3 delivered confetti infrastructure
@.planning/phases/03-task-completion-experience/03-03-SUMMARY.md

# Existing confetti library with fireAllTasksConfetti ready
@src/lib/confetti.ts

# Existing haptics utility
@src/lib/haptics.ts

# VandaagPage where celebration should trigger
@src/app/(main)/vandaag/page.tsx

# Research findings
@.planning/phases/04-celebrations-and-streaks/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePrevious hook utility</name>
  <files>src/lib/hooks.ts</files>
  <action>
Create new file src/lib/hooks.ts with usePrevious hook following the developerway.com pattern from research.

Implementation:
- Generic usePrevious<T>(value: T) function that returns T | undefined
- Uses useRef to store { value: T; prev: T | undefined }
- Updates ref when value changes, preserving previous
- Returns ref.current.prev
- Add JSDoc comment explaining usage

This hook enables detecting state transitions (e.g., from 2 completed → 3 completed when total is 3).

Why this approach: Standard React pattern for comparing current vs previous render values, verified in research. Simple implementation, no library needed.
  </action>
  <verify>TypeScript compiles without errors, usePrevious exported from module</verify>
  <done>src/lib/hooks.ts exists with usePrevious hook, properly typed, documented</done>
</task>

<task type="auto">
  <name>Task 2: Add all-tasks celebration trigger to VandaagPage</name>
  <files>src/app/(main)/vandaag/page.tsx</files>
  <action>
Import and use celebration logic in VandaagPage component:

1. Import:
   - usePrevious from '@/lib/hooks'
   - fireAllTasksConfetti from '@/lib/confetti'
   - triggerHaptic from '@/lib/haptics'

2. Track previous completedCount:
   ```typescript
   const prevCompletedCount = usePrevious(data?.completedCount);
   ```

3. Derive celebration condition:
   ```typescript
   const allTasksComplete = data && data.totalCount > 0 && data.completedCount === data.totalCount;
   const justCompletedAll = allTasksComplete &&
     prevCompletedCount !== undefined &&
     prevCompletedCount < data.totalCount;
   ```

4. Add useEffect to fire celebration:
   ```typescript
   useEffect(() => {
     if (justCompletedAll) {
       fireAllTasksConfetti();
       triggerHaptic('success');
     }
   }, [justCompletedAll]);
   ```

Why this approach:
- usePrevious prevents firing on page load when data arrives already complete
- Condition checks transition from incomplete to complete, not just "is complete"
- useEffect with justCompletedAll dependency ensures it runs exactly once per transition
- Combines confetti + haptic for multi-sensory celebration
- No changes needed to task items - celebration is page-level concern

Anti-pattern avoided: Don't trigger in handleToggleTask or task items - would fire multiple times or at wrong moment. Detect at page level using derived state.
  </action>
  <verify>
npm run build succeeds with no TypeScript errors
Manual test: Complete remaining tasks one by one, verify confetti only on last task completion
Manual test: Refresh page when all complete - no confetti fires
  </verify>
  <done>
All tasks completion triggers fireAllTasksConfetti + haptic exactly once per transition
No celebration on page load with complete data
No celebration when unchecking tasks
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify celebration timing and behavior</name>
  <files>src/app/(main)/vandaag/page.tsx</files>
  <action>
Test the celebration behavior:

1. Start dev server: npm run dev
2. Navigate to /vandaag
3. Test scenarios:
   - Complete tasks one by one → confetti only on final task
   - Refresh page when all complete → no confetti
   - Uncheck a task, recheck it → confetti fires when returning to all-complete
   - Complete all tasks from empty state → confetti fires
4. Check browser console for any errors
5. Verify confetti respects prefers-reduced-motion (already built into fireAllTasksConfetti)

Expected behavior:
- Confetti fires from center of screen (origin: {x: 0.5, y: 0.5})
- 80 particles, wider spread than single-task confetti
- Haptic feedback accompanies visual celebration
- Only triggers on incomplete → complete transition
- Never fires on page load or refresh

If any issues found, fix them before marking complete.
  </action>
  <verify>All test scenarios pass, celebration feels right, no console errors</verify>
  <done>All-tasks celebration works correctly across all scenarios, timing feels natural</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] TypeScript compiles without errors
- [ ] usePrevious hook exists and is properly typed
- [ ] VandaagPage imports and uses celebration logic
- [ ] Completing final task fires confetti + haptic
- [ ] Page refresh with complete state does NOT fire confetti
- [ ] Celebration only fires on transition, not on state
</verification>

<success_criteria>

- All tasks completed
- usePrevious hook implemented and exported
- VandaagPage detects all-complete transition correctly
- fireAllTasksConfetti fires exactly once per transition
- Haptic feedback accompanies celebration
- No confetti on page load when data arrives complete
- Build succeeds with no errors
- Manual testing confirms correct behavior
  </success_criteria>

<output>
After completion, create `.planning/phases/04-celebrations-and-streaks/04-01-SUMMARY.md`
</output>
