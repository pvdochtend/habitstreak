---
phase: 07-streak-calculation-fix
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/streak.ts
  - src/app/api/insights/route.ts
  - src/app/api/today/route.ts
  - src/types/index.ts
  - tests/unit/streak.test.ts
autonomous: true

must_haves:
  truths:
    - "User with 2 ALL_WEEK tasks and dailyTarget=3 succeeds on Saturday after completing both"
    - "Streak doesn't break when weekend has fewer scheduled tasks than dailyTarget"
    - "Insights page shows correct isSuccessful values for low-scheduled days"
    - "Today page shows correct isSuccessful when totalCount < dailyTarget"
  artifacts:
    - path: "src/lib/streak.ts"
      provides: "isDaySuccessful pure function + updated calculate functions"
      exports: ["isDaySuccessful", "calculateCurrentStreak", "calculateBestStreak"]
      contains: "effectiveTarget = Math.min"
    - path: "tests/unit/streak.test.ts"
      provides: "Comprehensive streak unit tests"
      min_lines: 80
  key_links:
    - from: "src/app/api/insights/route.ts"
      to: "isDaySuccessful"
      via: "import and call"
      pattern: "import.*isDaySuccessful.*from.*@/lib/streak"
    - from: "src/app/api/today/route.ts"
      to: "isDaySuccessful"
      via: "import and call"
      pattern: "import.*isDaySuccessful.*from.*@/lib/streak"
---

<objective>
Fix the streak calculation bug where days with fewer scheduled tasks than dailyTarget incorrectly break streaks.

Purpose: Users with WORKWEEK tasks should maintain streaks on weekends when completing all scheduled tasks, even if scheduledCount < dailyTarget.

Output: Pure `isDaySuccessful()` function, updated streak calculations, and comprehensive unit tests following TDD methodology.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-streak-calculation-fix/07-RESEARCH.md

@src/lib/streak.ts
@src/app/api/insights/route.ts
@src/app/api/today/route.ts
@src/types/index.ts
@tests/unit/schedule.test.ts — reference for test patterns
</context>

<feature>
  <name>isDaySuccessful with effectiveTarget logic</name>
  <files>src/lib/streak.ts, tests/unit/streak.test.ts</files>
  <behavior>
    **Core formula:**
    - effectiveTarget = min(dailyTarget, scheduledCount)
    - isSuccessful = completedCount >= effectiveTarget
    - scheduledCount === 0 returns false (caller should skip these days)

    **Test cases (input → expected output):**
    Basic:
    - isDaySuccessful(3, 5, 3) → true (completed >= target)
    - isDaySuccessful(2, 5, 3) → false (completed < target)

    Effective target when scheduledCount < dailyTarget:
    - isDaySuccessful(2, 2, 3) → true (all scheduled completed, fewer than target)
    - isDaySuccessful(1, 2, 3) → false (not all scheduled completed)
    - isDaySuccessful(1, 1, 3) → true (single task scenario)
    - isDaySuccessful(0, 1, 3) → false (didn't complete single task)

    Zero scheduled:
    - isDaySuccessful(0, 0, 3) → false (no tasks scheduled)

    Edge cases:
    - isDaySuccessful(1, 5, 1) → true (dailyTarget=1)
    - isDaySuccessful(3, 3, 3) → true (equal scheduled and target)
    - isDaySuccessful(2, 2, 10) → true (high target, few tasks)
  </behavior>
  <implementation>
    1. Create isDaySuccessful() pure function in src/lib/streak.ts
    2. Update calculateCurrentStreak() line 81 to use isDaySuccessful()
    3. Update calculateBestStreak() line 176 to use isDaySuccessful()
    4. Update src/app/api/insights/route.ts line 80 to import and use isDaySuccessful()
    5. Update src/app/api/today/route.ts line 65 to import and use isDaySuccessful()
    6. Update src/types/index.ts comments on isSuccessful fields (lines 82, 109)
  </implementation>
</feature>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all tests including new streak.test.ts
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] All 4 locations use isDaySuccessful() function (grep confirms)
</verification>

<success_criteria>

- RED: Failing tests written for isDaySuccessful() covering all test cases
- GREEN: isDaySuccessful() implemented and all tests pass
- REFACTOR: All 4 call sites updated to use centralized function
- Tests verify WORKWEEK/WEEKEND edge cases explicitly
- Type comments updated to reflect new formula
  </success_criteria>

<output>
After completion, create `.planning/phases/07-streak-calculation-fix/07-01-SUMMARY.md`
</output>
