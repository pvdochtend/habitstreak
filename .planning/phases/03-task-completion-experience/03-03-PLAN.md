---
phase: 03-task-completion-experience
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - package.json
  - src/lib/confetti.ts
  - src/components/tasks/today-task-item.tsx
  - src/components/tasks/celebration-effect.tsx
autonomous: false

must_haves:
  truths:
    - "User sees canvas-confetti burst when completing a task"
    - "Confetti originates from the completed task position"
    - "Confetti respects reduced-motion preference"
  artifacts:
    - path: "src/lib/confetti.ts"
      provides: "Confetti utility wrapping canvas-confetti with task completion preset"
      min_lines: 25
      exports: ["fireTaskConfetti"]
    - path: "package.json"
      provides: "canvas-confetti dependency"
      contains: "canvas-confetti"
  key_links:
    - from: "confetti.ts"
      to: "today-task-item.tsx"
      via: "fireTaskConfetti call on task completion"
      pattern: "fireTaskConfetti"
---

<objective>
Integrate canvas-confetti library for rich, performant confetti effects on task completion.

Purpose: Replace CSS-based confetti with canvas-confetti for better visual impact, GPU acceleration, and more realistic physics.
Output: canvas-confetti integrated with task completion, firing from task position with customized particles.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-task-completion-experience/03-01-PLAN.md
@.planning/phases/03-task-completion-experience/03-02-PLAN.md

Relevant source files:
@src/components/tasks/today-task-item.tsx
@src/components/tasks/celebration-effect.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install canvas-confetti package</name>
  <files>package.json</files>
  <action>
Install canvas-confetti and its TypeScript types:

```bash
npm install canvas-confetti
npm install -D @types/canvas-confetti
```

canvas-confetti is a lightweight (~3KB gzipped) library for GPU-accelerated confetti.

Verify installation:
- package.json shows "canvas-confetti" in dependencies
- @types/canvas-confetti in devDependencies
  </action>
  <verify>
- npm install completes without errors
- package.json contains canvas-confetti
- npm run build succeeds (TypeScript recognizes types)
  </verify>
  <done>canvas-confetti installed with TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create confetti utility module</name>
  <files>src/lib/confetti.ts</files>
  <action>
Create a utility module that wraps canvas-confetti for task completion:

```typescript
import confetti from 'canvas-confetti';

/**
 * Check if user prefers reduced motion
 */
function prefersReducedMotion(): boolean {
  if (typeof window === 'undefined') return false;
  return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
}

/**
 * Fire confetti for task completion
 * @param origin - Origin point {x, y} as ratios of viewport (0-1)
 */
export function fireTaskConfetti(origin?: { x: number; y: number }): void {
  // Skip confetti for reduced motion preference
  if (prefersReducedMotion()) return;

  // Default to center-ish if no origin provided
  const defaultOrigin = { x: 0.5, y: 0.6 };
  const finalOrigin = origin || defaultOrigin;

  // Small, quick confetti burst - not overwhelming
  confetti({
    particleCount: 30,
    spread: 60,
    origin: finalOrigin,
    colors: [
      '#3b82f6', // blue-500 (primary blue)
      '#ec4899', // pink-500 (primary pink)
      '#22c55e', // green-500
      '#f59e0b', // amber-500
      '#8b5cf6', // violet-500
    ],
    startVelocity: 25,
    gravity: 1.2,
    ticks: 60,
    scalar: 0.8, // Slightly smaller particles
    shapes: ['circle', 'square'],
    disableForReducedMotion: true, // Built-in reduced motion support
  });
}

/**
 * Fire larger confetti for all tasks complete (used in Phase 4)
 * Exported for future use
 */
export function fireAllTasksConfetti(): void {
  if (prefersReducedMotion()) return;

  // Bigger celebration for completing all tasks
  confetti({
    particleCount: 80,
    spread: 100,
    origin: { x: 0.5, y: 0.5 },
    colors: ['#3b82f6', '#ec4899', '#22c55e', '#f59e0b', '#8b5cf6'],
    startVelocity: 35,
    gravity: 1,
    ticks: 100,
    scalar: 1,
    disableForReducedMotion: true,
  });
}
```

Features:
- Respects prefers-reduced-motion
- Custom origin support (for firing from task position)
- Color palette matches app theme (blue/pink primary with accents)
- Moderate particle count for subtle "spark of joy" not overwhelming
- fireAllTasksConfetti exported for Phase 4 use
  </action>
  <verify>
- File exists at src/lib/confetti.ts
- TypeScript compiles without errors
- Exports fireTaskConfetti and fireAllTasksConfetti
  </verify>
  <done>Confetti utility created with task completion preset</done>
</task>

<task type="auto">
  <name>Task 3: Integrate canvas-confetti into task completion</name>
  <files>src/components/tasks/today-task-item.tsx</files>
  <action>
Update TodayTaskItem to fire canvas-confetti on task completion:

1. Import the confetti utility:
```typescript
import { fireTaskConfetti } from '@/lib/confetti';
```

2. Add a ref to get the button element position:
```typescript
import { useState, useRef } from 'react';
// ...
const buttonRef = useRef<HTMLButtonElement>(null);
```

3. Create helper to calculate confetti origin from button position:
```typescript
const getConfettiOrigin = (): { x: number; y: number } | undefined => {
  if (!buttonRef.current) return undefined;

  const rect = buttonRef.current.getBoundingClientRect();
  // Calculate center of button as viewport ratio
  const x = (rect.left + rect.width / 2) / window.innerWidth;
  const y = (rect.top + rect.height / 2) / window.innerHeight;

  return { x, y };
};
```

4. In handleToggle, fire confetti after haptic feedback:
```typescript
if (willComplete) {
  triggerHaptic('success');

  // Fire confetti from button position
  fireTaskConfetti(getConfettiOrigin());

  setIsAnimating(true);
  setShowCelebration(true);
  // ... rest
}
```

5. Add ref to button element:
```tsx
<button
  ref={buttonRef}
  onClick={handleToggle}
  // ... rest of props
>
```

6. The timing: haptic → confetti → CSS animations → API call
   This creates layered feedback: immediate haptic, quick confetti burst, then slower CSS animations.
  </action>
  <verify>
- npm run build succeeds
- npm run lint passes
- TodayTaskItem imports fireTaskConfetti
- Button has ref attached
- Confetti fires on task completion
  </verify>
  <done>canvas-confetti integrated into task completion, fires from task position</done>
</task>

<task type="auto">
  <name>Task 4: Simplify CelebrationEffect (optional particles alongside confetti)</name>
  <files>src/components/tasks/celebration-effect.tsx</files>
  <action>
Now that we have canvas-confetti handling the main confetti effect, CelebrationEffect can focus on the local particle burst (close-range particles around the checkbox).

Adjust CelebrationEffect to complement confetti:

1. Reduce particle count to 8-10 (confetti handles the main burst)
2. Keep particles small and fast (accent to confetti, not competing)
3. Shorten animation duration to 400ms (faster than confetti's ~600ms travel)
4. Particles should stay close (25-45px range) for "sparkle" around checkbox

The combination:
- CelebrationEffect: Small, fast sparkles right at the checkbox
- canvas-confetti: Larger confetti burst spreading across screen

This creates depth - local sparkle + global celebration.

If the visual is too busy, the particle count can be reduced further or CelebrationEffect can be simplified to just a glow effect. The canvas-confetti is the hero celebration.
  </action>
  <verify>
- npm run build succeeds
- CelebrationEffect still functions (doesn't break)
- Particle count reduced for complementary role
  </verify>
  <done>CelebrationEffect adjusted to complement canvas-confetti</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete task completion experience with checkmark animation, color fill, particle burst, haptic feedback, and canvas-confetti</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/vandaag (log in if needed)
    3. Have at least one uncompleted task visible
    4. Tap/click to complete a task and observe:
       - Checkmark draws with stroke animation (not just appearing)
       - Checkbox fills with spring animation
       - Task row has subtle color transition
       - Small sparkle particles near checkbox
       - Confetti burst spreads from task position
       - On mobile: feel haptic vibration
    5. Uncomplete the task (tap again) - should NOT trigger celebrations
    6. Complete again - verify all effects play
    7. Test reduced motion:
       - In browser DevTools: Rendering → Emulate prefers-reduced-motion: reduce
       - Complete a task - should have NO animations/confetti
    8. Verify no console errors during interactions
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes without errors
- [ ] canvas-confetti package installed
- [ ] src/lib/confetti.ts exists with correct exports
- [ ] TodayTaskItem fires confetti from task position
- [ ] Confetti respects reduced-motion preference
- [ ] Visual verification passed by user
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- canvas-confetti fires from task position on completion
- Confetti disabled when prefers-reduced-motion is set
- User verified the complete task completion experience
- CelebrationEffect and confetti work together harmoniously
</success_criteria>

<output>
After completion, create `.planning/phases/03-task-completion-experience/03-03-SUMMARY.md`
</output>
