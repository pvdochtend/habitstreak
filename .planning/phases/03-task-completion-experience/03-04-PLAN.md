---
phase: 03-task-completion-experience
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tasks/today-task-item.tsx
  - src/app/globals.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Checkbox fills immediately on tap (before API response)"
    - "Checkmark appears immediately on tap (before API response)"
    - "Background color transition is visible on completion"
    - "Animation sequence feels coordinated, not jarring"
  artifacts:
    - path: "src/components/tasks/today-task-item.tsx"
      provides: "Optimistic local state for immediate visual feedback"
      contains: "localIsCompleted"
  key_links:
    - from: "localIsCompleted state"
      to: "checkbox/checkmark visual rendering"
      via: "conditional classes use localIsCompleted not task.isCompleted"
      pattern: "localIsCompleted"
---

<objective>
Implement optimistic UI for task completion so all animations play immediately on tap.

Purpose: Fix jarring experience where celebrations fire before checkbox visually completes. All visual feedback should be instant.
Output: Task completion feels snappy and coordinated - tap → instant visual feedback → API call happens in background.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-task-completion-experience/03-UAT.md

Relevant source files:
@src/components/tasks/today-task-item.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic local state for immediate visual feedback</name>
  <files>src/components/tasks/today-task-item.tsx</files>
  <action>
Add optimistic local state that flips immediately on click, decoupling visual state from server state:

1. Add state: `const [localIsCompleted, setLocalIsCompleted] = useState(task.isCompleted)`

2. Sync with props when task.isCompleted changes (useEffect):
```typescript
useEffect(() => {
  setLocalIsCompleted(task.isCompleted)
}, [task.isCompleted])
```

3. In handleToggle, flip localIsCompleted IMMEDIATELY (before any async work):
```typescript
const handleToggle = async () => {
  const willComplete = !localIsCompleted

  // Optimistic update - flip visual state immediately
  setLocalIsCompleted(willComplete)

  if (willComplete) {
    triggerHaptic('success')
    fireTaskConfetti(getConfettiOrigin())
    setIsAnimating(true)
    setShowCelebration(true)
  }

  setIsLoading(true)
  try {
    await onToggle(task.id, task.isCompleted) // Still pass original for API
  } catch {
    // Rollback on error
    setLocalIsCompleted(task.isCompleted)
  } finally {
    setIsLoading(false)
    if (willComplete) {
      setTimeout(() => {
        setIsAnimating(false)
        setShowCelebration(false)
      }, 800)
    }
  }
}
```

4. Replace ALL visual uses of `task.isCompleted` with `localIsCompleted`:
- Checkbox background color conditional
- Checkmark visibility (`{localIsCompleted && <AnimatedCheckmark ... />}`)
- Task icon color
- Task title strikethrough
- ARIA pressed state

Keep task.isCompleted for the onToggle API call (second param is the original state).
  </action>
  <verify>
- npm run build succeeds
- npm run lint passes
- TypeScript has no errors
  </verify>
  <done>Visual state updates immediately on click, before API response</done>
</task>

<task type="auto">
  <name>Task 2: Fix background animation to work with optimistic state</name>
  <files>src/components/tasks/today-task-item.tsx, src/app/globals.css</files>
  <action>
The background animation competes with conditional bg classes. Fix by using CSS transition instead of keyframe animation:

1. In globals.css, replace the taskComplete keyframe approach:
```css
/* Remove or simplify animate-task-complete if it conflicts */
.animate-task-complete {
  /* Use transition instead of animation for background */
  transition: background-color 0.5s ease-out, box-shadow 0.5s ease-out;
}
```

2. In TodayTaskItem, restructure the button classes:
- Remove the conditional bg-card/bg-primary/5 that fights with animation
- Use a single background approach that transitions smoothly:

```tsx
className={cn(
  'w-full flex items-center gap-4 p-4 rounded-lg border transition-all duration-200 touch-target animate-slide-up',
  'hover:shadow-md active:scale-[0.98]',
  'disabled:opacity-50 disabled:cursor-not-allowed',
  // Background transitions via CSS transition, not animation
  localIsCompleted
    ? 'bg-primary/5 border-primary shadow-sm'
    : 'bg-card border-border',
  // Glow effect during animation
  isAnimating && 'animate-glow'
)}
```

3. Remove animate-task-complete class if it's not working well - the bg-primary/5 transition IS the background effect, just needs the transition property to animate it.

4. Add transition-colors to ensure background animates:
```tsx
'transition-all duration-500'  // or transition-colors
```

The goal: When localIsCompleted flips, the background smoothly transitions from bg-card to bg-primary/5.
  </action>
  <verify>
- npm run build succeeds
- Visually verify: background color transitions smoothly (not instant jump)
  </verify>
  <done>Background color transition is visible and smooth on task completion</done>
</task>

<task type="auto">
  <name>Task 3: Soften spring easing for less jarring animation</name>
  <files>src/app/globals.css</files>
  <action>
The spring bounce cubic-bezier(0.34, 1.56, 0.64, 1) overshoots too much (1.56 = 56% overshoot).

Soften to a gentler spring:

1. Find the checkboxFill animation:
```css
.animate-checkbox-fill {
  animation: checkboxFill 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
```

2. Change to softer spring (20-25% overshoot feels snappy but not jarring):
```css
.animate-checkbox-fill {
  animation: checkboxFill 0.3s cubic-bezier(0.34, 1.25, 0.64, 1);
}
```

The difference:
- 1.56 overshoot: Bouncy, playful but can feel chaotic with other animations
- 1.25 overshoot: Still has satisfying "pop" but more refined

This is a subtle change that makes the overall experience feel more polished.
  </action>
  <verify>
- npm run build succeeds
- Visually verify: checkbox still has bounce but less exaggerated
  </verify>
  <done>Spring animation feels satisfying but not jarring</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes without errors
- [ ] Visual state updates immediately on tap (no waiting for API)
- [ ] Background color transitions smoothly
- [ ] Animation sequence feels coordinated
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Checkbox, checkmark, and background all respond instantly on tap
- Particles, haptics, and visual state are synchronized
- Spring bounce is satisfying but not chaotic
</success_criteria>

<output>
After completion, create `.planning/phases/03-task-completion-experience/03-04-SUMMARY.md`
</output>
