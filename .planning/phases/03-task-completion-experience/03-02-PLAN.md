---
phase: 03-task-completion-experience
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/tasks/celebration-effect.tsx
  - src/lib/haptics.ts
  - src/components/tasks/today-task-item.tsx
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "User sees particles burst outward from completed task"
    - "User feels vibration on mobile when completing a task"
    - "Particle animations have varied sizes and trajectories"
  artifacts:
    - path: "src/lib/haptics.ts"
      provides: "Haptic feedback utility using Navigator Vibration API"
      min_lines: 15
      exports: ["triggerHaptic"]
    - path: "src/components/tasks/celebration-effect.tsx"
      provides: "Enhanced particle system with radial burst"
      min_lines: 50
  key_links:
    - from: "haptics.ts"
      to: "today-task-item.tsx"
      via: "triggerHaptic call on task completion"
      pattern: "triggerHaptic"
    - from: "celebration-effect.tsx"
      to: "today-task-item.tsx"
      via: "CelebrationEffect component with enhanced particles"
      pattern: "CelebrationEffect"
---

<objective>
Implement particle burst animation and haptic feedback for task completion.

Purpose: Add physical feedback (vibration) and visual particle effects that burst from the task when completed.
Output: Enhanced CelebrationEffect with better particles, haptic feedback utility integrated into task completion flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-task-completion-experience/03-01-PLAN.md

Relevant source files:
@src/components/tasks/today-task-item.tsx
@src/components/tasks/celebration-effect.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create haptic feedback utility</name>
  <files>src/lib/haptics.ts</files>
  <action>
Create a utility module for haptic feedback using the Navigator Vibration API:

```typescript
/**
 * Haptic feedback utility for mobile devices
 * Uses the Navigator Vibration API with graceful fallback
 */

/**
 * Check if vibration is supported
 */
export function isHapticSupported(): boolean {
  return typeof window !== 'undefined' && 'vibrate' in navigator;
}

/**
 * Trigger haptic feedback
 * @param pattern - Vibration pattern in ms. Single number or array of [vibrate, pause, vibrate, ...]
 * @param type - Preset type: 'light' (10ms), 'medium' (20ms), 'heavy' (30ms), 'success' (pattern)
 */
export function triggerHaptic(
  type: 'light' | 'medium' | 'heavy' | 'success' | 'error' = 'medium'
): void {
  if (!isHapticSupported()) return;

  const patterns: Record<string, number | number[]> = {
    light: 10,
    medium: 20,
    heavy: 30,
    success: [15, 50, 25], // short-pause-longer for completion feel
    error: [50, 50, 50],   // triple pulse for error
  };

  try {
    navigator.vibrate(patterns[type]);
  } catch {
    // Silently fail - haptics are non-critical
  }
}
```

Features:
- SSR-safe (checks for window)
- Graceful fallback when not supported
- Preset patterns for common use cases
- 'success' pattern specifically tuned for task completion
  </action>
  <verify>
- File exists at src/lib/haptics.ts
- TypeScript compiles without errors
- Exports triggerHaptic and isHapticSupported
  </verify>
  <done>Haptic feedback utility created with success pattern for task completion</done>
</task>

<task type="auto">
  <name>Task 2: Enhance CelebrationEffect with improved particle system</name>
  <files>src/components/tasks/celebration-effect.tsx, src/app/globals.css</files>
  <action>
Upgrade the particle system in CelebrationEffect for better visual impact:

1. Update particle generation:
   - Increase to 16-20 particles for fuller burst
   - Add size variation (small: 4px, medium: 6px, large: 8px)
   - Add shape variation (circles and small squares/diamonds)
   - Radial distribution: particles spread in 360° from center
   - Varied velocities for more natural effect

2. Update particle structure:
```typescript
interface Particle {
  id: number;
  angle: number;      // Direction in radians (0 to 2π)
  distance: number;   // How far to travel (30-80px)
  size: 'sm' | 'md' | 'lg';
  shape: 'circle' | 'square';
  color: string;
  delay: number;      // Stagger the start (0-100ms)
}
```

3. Generate particles in handleShow:
```typescript
const newParticles = Array.from({ length: 18 }, (_, i) => ({
  id: i,
  angle: (i / 18) * Math.PI * 2 + (Math.random() * 0.3 - 0.15), // Radial with jitter
  distance: 35 + Math.random() * 45, // 35-80px
  size: ['sm', 'md', 'lg'][Math.floor(Math.random() * 3)] as 'sm' | 'md' | 'lg',
  shape: Math.random() > 0.3 ? 'circle' : 'square' as 'circle' | 'square',
  color: colors[Math.floor(Math.random() * colors.length)],
  delay: i * 15, // Stagger by 15ms each
}));
```

4. Update particle rendering to use CSS custom properties:
```tsx
<div
  key={particle.id}
  className={cn(
    'particle absolute',
    particle.shape === 'circle' ? 'rounded-full' : 'rotate-45',
    particle.color,
    particle.size === 'sm' ? 'w-1 h-1' : particle.size === 'md' ? 'w-1.5 h-1.5' : 'w-2 h-2'
  )}
  style={{
    '--particle-x': `${Math.cos(particle.angle) * particle.distance}px`,
    '--particle-y': `${Math.sin(particle.angle) * particle.distance}px`,
    left: '50%',
    top: '50%',
    animationDelay: `${particle.delay}ms`,
  } as React.CSSProperties}
/>
```

5. Add new CSS animation in globals.css:
```css
@keyframes particleBurst {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  20% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(
      calc(-50% + var(--particle-x, 0px)),
      calc(-50% + var(--particle-y, 0px))
    ) scale(0.3);
    opacity: 0;
  }
}

.particle {
  animation: particleBurst 0.6s ease-out forwards;
  pointer-events: none;
}
```

6. Update reduced-motion section to include `.particle` class.
  </action>
  <verify>
- npm run build succeeds
- CelebrationEffect generates particles with new structure
- CSS animation uses custom properties for direction
- Reduced motion section includes particle class
  </verify>
  <done>CelebrationEffect enhanced with radial particle burst, varied sizes and shapes</done>
</task>

<task type="auto">
  <name>Task 3: Integrate haptic feedback into task completion flow</name>
  <files>src/components/tasks/today-task-item.tsx</files>
  <action>
Add haptic feedback to the task completion interaction:

1. Import the haptic utility:
```typescript
import { triggerHaptic } from '@/lib/haptics';
```

2. In handleToggle, trigger haptic when completing (not uncompleting):
```typescript
const handleToggle = async () => {
  setIsLoading(true);
  const willComplete = !task.isCompleted;

  if (willComplete) {
    // Trigger haptic immediately for instant feedback
    triggerHaptic('success');

    setIsAnimating(true);
    setShowCelebration(true);

    await new Promise((resolve) => setTimeout(resolve, 100));
  }
  // ... rest of function
};
```

3. The haptic triggers BEFORE the visual animations start, giving immediate tactile feedback while visuals catch up (perceived latency reduction).

4. Ensure the haptic call is at the very start of the "willComplete" block, before any state updates.
  </action>
  <verify>
- npm run build succeeds
- npm run lint passes
- TodayTaskItem imports triggerHaptic
- Haptic triggers on task completion
  </verify>
  <done>Haptic feedback integrated into task completion with 'success' pattern</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes without errors
- [ ] src/lib/haptics.ts exists with correct exports
- [ ] CelebrationEffect uses enhanced particle system
- [ ] Particles burst radially with varied sizes
- [ ] TodayTaskItem triggers haptic on completion
- [ ] New animations added to reduced-motion section
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Particles burst in 360° pattern from task center
- Particles have size and shape variation
- Haptic feedback triggers on mobile (or silently no-ops on desktop)
- Animations respect prefers-reduced-motion
</success_criteria>

<output>
After completion, create `.planning/phases/03-task-completion-experience/03-02-SUMMARY.md`
</output>
