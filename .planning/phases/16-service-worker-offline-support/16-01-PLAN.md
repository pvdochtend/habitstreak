---
phase: 16-service-worker-offline-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - public/sw.js
  - src/components/pwa/service-worker-registration.tsx
  - src/app/layout.tsx
  - next.config.js
autonomous: true

must_haves:
  truths:
    - "Service worker registers on app load"
    - "Service worker has a fetch handler that responds"
    - "sw.js serves with no-cache headers"
  artifacts:
    - path: "public/sw.js"
      provides: "Service worker with fetch handler"
      contains: "addEventListener('fetch'"
    - path: "src/components/pwa/service-worker-registration.tsx"
      provides: "SW registration component"
      exports: ["ServiceWorkerRegistration"]
    - path: "next.config.js"
      provides: "Cache-Control headers for sw.js"
      contains: "/sw.js"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/components/pwa/service-worker-registration.tsx"
      via: "import and render"
      pattern: "ServiceWorkerRegistration"
    - from: "src/components/pwa/service-worker-registration.tsx"
      to: "public/sw.js"
      via: "navigator.serviceWorker.register"
      pattern: "register\\('/sw.js'"
---

<objective>
Create minimal service worker with fetch handler and registration

Purpose: Enable Chromium install prompts (beforeinstallprompt requires a functioning fetch handler) and establish SW foundation for caching.
Output: Working service worker that registers on app load and passes through requests.
</objective>

<execution_context>
@/home/pvdochtend/.claude/get-shit-done/workflows/execute-plan.md
@/home/pvdochtend/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-service-worker-offline-support/16-RESEARCH.md

# Existing PWA infrastructure
@src/contexts/pwa-install-context.tsx
@src/app/layout.tsx
@next.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create minimal service worker</name>
  <files>public/sw.js</files>
  <action>
Create vanilla JavaScript service worker at `public/sw.js` with:

1. Cache version constant (for later use):
```javascript
const CACHE_VERSION = 'v1'
const CACHE_NAME = `habitstreak-${CACHE_VERSION}`
```

2. Install event listener (minimal for now):
```javascript
self.addEventListener('install', (event) => {
  // Skip waiting to activate immediately
  self.skipWaiting()
})
```

3. Activate event listener with clients.claim():
```javascript
self.addEventListener('activate', (event) => {
  event.waitUntil(
    self.clients.claim()
  )
})
```

4. Fetch handler that passes through requests (CRITICAL - Chrome requires this for beforeinstallprompt):
```javascript
self.addEventListener('fetch', (event) => {
  // Skip non-GET requests
  if (event.request.method !== 'GET') {
    return
  }

  // Network-only for API routes (never cache)
  const url = new URL(event.request.url)
  if (url.pathname.startsWith('/api/')) {
    return
  }

  // Default: network passthrough (caching added in 16-02)
  event.respondWith(fetch(event.request))
})
```

The fetch handler MUST call `event.respondWith()` for at least some requests - an empty handler will not trigger beforeinstallprompt.
  </action>
  <verify>File exists at public/sw.js and contains addEventListener('fetch') with respondWith</verify>
  <done>sw.js file exists with install, activate, and fetch event listeners</done>
</task>

<task type="auto">
  <name>Task 2: Create registration component and wire into layout</name>
  <files>src/components/pwa/service-worker-registration.tsx, src/app/layout.tsx</files>
  <action>
Create registration component at `src/components/pwa/service-worker-registration.tsx`:

```typescript
'use client'

import { useEffect } from 'react'

export function ServiceWorkerRegistration() {
  useEffect(() => {
    if (typeof window === 'undefined') return
    if (!('serviceWorker' in navigator)) return

    const registerSW = async () => {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js', {
          scope: '/',
        })

        if (process.env.NODE_ENV === 'development') {
          console.log('Service Worker registered:', registration.scope)
        }
      } catch (error) {
        console.error('Service Worker registration failed:', error)
      }
    }

    registerSW()
  }, [])

  return null
}
```

Update `src/app/layout.tsx`:
1. Import ServiceWorkerRegistration from '@/components/pwa/service-worker-registration'
2. Add `<ServiceWorkerRegistration />` inside the body, after PwaInstallProvider closing tag but before body closing tag

The component renders null - it only exists to register the SW via useEffect.
  </action>
  <verify>grep -q "ServiceWorkerRegistration" src/app/layout.tsx</verify>
  <done>Registration component exists and is imported in root layout</done>
</task>

<task type="auto">
  <name>Task 3: Add Cache-Control headers for sw.js</name>
  <files>next.config.js</files>
  <action>
Update `next.config.js` to add Cache-Control headers for sw.js.

In the existing `headers()` async function, add a new entry to the return array:

```javascript
{
  source: '/sw.js',
  headers: [
    {
      key: 'Cache-Control',
      value: 'no-cache, no-store, must-revalidate',
    },
    {
      key: 'Content-Type',
      value: 'application/javascript; charset=utf-8',
    },
  ],
},
```

This prevents browsers from caching sw.js, ensuring updates deploy immediately.

Keep all existing headers (X-DNS-Prefetch-Control, X-Frame-Options, etc.) - just add this new entry.
  </action>
  <verify>grep -q "sw.js" next.config.js && grep -q "no-cache" next.config.js</verify>
  <done>next.config.js includes no-cache headers for /sw.js</done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and open http://localhost:3000
2. Open DevTools > Application > Service Workers
3. Verify service worker is registered with scope "/"
4. Verify sw.js status shows "activated and is running"
5. Check Network tab: requests should still work normally (passthrough)
6. Check Response Headers for sw.js: should include Cache-Control: no-cache
</verification>

<success_criteria>
- Service worker registers on app load (visible in DevTools)
- Service worker has fetch handler (not empty)
- sw.js served with no-cache headers
- All existing functionality still works (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/16-service-worker-offline-support/16-01-SUMMARY.md`
</output>
