---
phase: 16-service-worker-offline-support
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/offline/page.tsx
  - public/sw.js
autonomous: true

must_haves:
  truths:
    - "Offline page exists at /offline"
    - "Offline page shows Dutch message"
    - "Offline page uses glassmorphism styling"
    - "Navigation while offline shows offline page"
  artifacts:
    - path: "src/app/offline/page.tsx"
      provides: "Offline fallback page"
      contains: "Je bent offline"
    - path: "public/sw.js"
      provides: "Navigation offline fallback"
      contains: "/offline"
  key_links:
    - from: "public/sw.js"
      to: "/offline"
      via: "caches.match on navigation failure"
      pattern: "caches.match\\('/offline'"
---

<objective>
Create branded offline fallback page

Purpose: Provide graceful degradation when network unavailable - users see a branded HabitStreak page instead of browser error.
Output: Dutch offline page with glassmorphism styling, service worker navigates to it on network failure.
</objective>

<execution_context>
@/home/pvdochtend/.claude/get-shit-done/workflows/execute-plan.md
@/home/pvdochtend/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-service-worker-offline-support/16-RESEARCH.md
@.planning/phases/16-service-worker-offline-support/16-01-SUMMARY.md

# Existing styling patterns
@src/app/globals.css
@src/components/pwa/ios-walkthrough-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create offline page</name>
  <files>src/app/offline/page.tsx</files>
  <action>
Create offline page at `src/app/offline/page.tsx`:

```typescript
import { WifiOff } from 'lucide-react'

export const metadata = {
  title: 'Offline - HabitStreak',
}

export default function OfflinePage() {
  return (
    <div className="min-h-screen flex items-center justify-center p-4 bg-background">
      <div className="glass rounded-2xl p-8 max-w-sm text-center space-y-4 animate-fade-in">
        <div className="w-16 h-16 mx-auto rounded-full bg-primary/10 flex items-center justify-center">
          <WifiOff className="w-8 h-8 text-primary" />
        </div>
        <h1 className="text-xl font-semibold">Je bent offline</h1>
        <p className="text-muted-foreground">
          Controleer je internetverbinding en probeer het opnieuw.
        </p>
        <button
          onClick={() => window.location.reload()}
          className="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-primary text-primary-foreground font-medium hover:bg-primary/90 transition-colors touch-target"
        >
          Opnieuw proberen
        </button>
      </div>
    </div>
  )
}
```

Wait - this is a Server Component but has onClick. Make it a Client Component:

```typescript
'use client'

import { WifiOff } from 'lucide-react'

export default function OfflinePage() {
  return (
    <div className="min-h-screen flex items-center justify-center p-4 bg-background">
      <div className="glass rounded-2xl p-8 max-w-sm text-center space-y-4 animate-fade-in">
        <div className="w-16 h-16 mx-auto rounded-full bg-primary/10 flex items-center justify-center">
          <WifiOff className="w-8 h-8 text-primary" />
        </div>
        <h1 className="text-xl font-semibold">Je bent offline</h1>
        <p className="text-muted-foreground">
          Controleer je internetverbinding en probeer het opnieuw.
        </p>
        <button
          onClick={() => window.location.reload()}
          className="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-primary text-primary-foreground font-medium hover:bg-primary/90 transition-colors touch-target"
        >
          Opnieuw proberen
        </button>
      </div>
    </div>
  )
}
```

Uses existing HabitStreak patterns:
- `glass` class for glassmorphism
- `animate-fade-in` for entry animation
- `touch-target` for mobile touch sizing
- Dutch text: "Je bent offline", "Controleer je internetverbinding"
  </action>
  <verify>grep -q "Je bent offline" src/app/offline/page.tsx</verify>
  <done>Offline page exists with Dutch message and glassmorphism styling</done>
</task>

<task type="auto">
  <name>Task 2: Add /offline to precache and update fetch handler</name>
  <files>public/sw.js</files>
  <action>
Update `public/sw.js` to precache the offline page and serve it on navigation failure.

1. Add '/offline' to PRECACHE_URLS array (first item, before icons):
```javascript
const PRECACHE_URLS = [
  '/offline',
  '/icons/icon-72x72.png',
  // ... rest of icons
]
```

2. Update the fetch handler to add offline fallback for navigation requests. Find the default case at the end of the fetch handler and replace it:

Before (from 16-02):
```javascript
// Default: network-first (passthrough, may add offline fallback later)
event.respondWith(
  fetch(event.request).catch(() => {
    return caches.match(event.request)
  })
)
```

After:
```javascript
// Navigation requests: network-first with offline fallback
if (event.request.mode === 'navigate') {
  event.respondWith(
    fetch(event.request).catch(() => {
      return caches.match('/offline')
    })
  )
  return
}

// Default: network-first
event.respondWith(
  fetch(event.request).catch(() => {
    return caches.match(event.request)
  })
)
```

This ensures:
- /offline is cached on SW install
- Any navigation failure shows the offline page instead of browser error
  </action>
  <verify>grep -q "'/offline'" public/sw.js && grep -q "navigate" public/sw.js</verify>
  <done>Offline page is precached and served on navigation failure</done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and visit http://localhost:3000/offline
2. Verify page shows "Je bent offline" with WifiOff icon
3. Verify glassmorphism styling (glass card effect)
4. Open DevTools > Application > Service Workers
5. Click "Offline" checkbox
6. Navigate to any page (e.g., /vandaag)
7. Verify offline page is shown instead of browser error
8. Uncheck "Offline", click "Opnieuw proberen" button
9. Verify app works again
</verification>

<success_criteria>
- /offline page exists with Dutch message
- Page uses HabitStreak glassmorphism styling
- Navigation while offline shows custom offline page
- "Opnieuw proberen" button reloads page
</success_criteria>

<output>
After completion, create `.planning/phases/16-service-worker-offline-support/16-03-SUMMARY.md`
</output>
