---
phase: 16-service-worker-offline-support
plan: 04
type: execute
wave: 3
depends_on: ["16-01", "16-02", "16-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "beforeinstallprompt fires on Chromium browsers"
    - "iOS Safari walkthrough still works"
    - "Lighthouse PWA audit passes"
    - "Production Docker build works with service worker"
  artifacts: []
  key_links: []
---

<objective>
Verify service worker implementation across platforms

Purpose: Confirm all requirements are met - install prompts work, caching works, offline works, production build works.
Output: Verified working service worker, no regressions, ready for production.
</objective>

<execution_context>
@/home/pvdochtend/.claude/get-shit-done/workflows/execute-plan.md
@/home/pvdochtend/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/16-service-worker-offline-support/16-01-SUMMARY.md
@.planning/phases/16-service-worker-offline-support/16-02-SUMMARY.md
@.planning/phases/16-service-worker-offline-support/16-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Lighthouse PWA audit</name>
  <files></files>
  <action>
Run Lighthouse CLI to verify PWA compliance:

```bash
# Build production version first
npm run build

# Start production server (in background or separate terminal)
npm run start &

# Wait for server to start
sleep 5

# Run Lighthouse PWA audit
npx lighthouse http://localhost:3000 --only-categories=pwa --output=json --output-path=./lighthouse-pwa.json --chrome-flags="--headless"

# Check results
cat lighthouse-pwa.json | jq '.categories.pwa.score'
```

Expected: PWA score should be high (0.9+). Key checks:
- Installable (has valid manifest + service worker)
- Has offline fallback
- Registers service worker

Note: Lighthouse PWA category is being deprecated but still useful for validation.

If Lighthouse CLI fails (headless Chrome issues on WSL), document the issue and move to manual DevTools verification.
  </action>
  <verify>Lighthouse audit runs or is documented as skipped with reason</verify>
  <done>Lighthouse PWA audit completed or documented as not feasible in environment</done>
</task>

<task type="auto">
  <name>Task 2: Verify production Docker build</name>
  <files></files>
  <action>
Build and test production Docker image:

```bash
# Build Docker image
docker build -t habitstreak:sw-test .

# Run container (use test database or skip db for static file check)
# Just verify the build succeeds and sw.js is included

# Check sw.js is in the image
docker run --rm habitstreak:sw-test ls -la /app/public/sw.js

# Check offline page is built
docker run --rm habitstreak:sw-test ls -la /app/.next/server/app/offline/
```

The key verification is that:
1. Docker build succeeds
2. public/sw.js is copied to production image
3. offline page is built by Next.js
  </action>
  <verify>Docker build succeeds and sw.js is present in image</verify>
  <done>Production Docker build verified with service worker included</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete service worker implementation:
- Service worker with fetch handler (enables Chromium install prompts)
- App shell caching (JS, CSS, icons)
- Dutch offline fallback page
- Cache versioning and cleanup
</what-built>
  <how-to-verify>
**Chrome/Edge Desktop:**
1. Open https://habitstreak.example.com (or localhost:3000)
2. Check DevTools > Application > Service Workers shows "activated"
3. Look for install icon in address bar (or three-dot menu > Install)
4. Verify beforeinstallprompt fires (check install banner appears)

**Chrome/Edge Android:**
1. Open habitstreak in Chrome
2. Wait for install banner or check menu > "Add to Home screen"
3. Verify app can be installed

**iOS Safari:**
1. Open habitstreak in Safari
2. Tap Share > "Add to Home Screen"
3. Verify walkthrough modal still works (no regression from v1.4)

**Offline Test (any platform):**
1. Install the app or open in browser
2. Go offline (airplane mode or DevTools > Network > Offline)
3. Navigate to any page
4. Verify "Je bent offline" page appears
5. Go back online
6. Click "Opnieuw proberen"
7. Verify app works

**Caching Test:**
1. Open DevTools > Application > Cache Storage
2. Verify habitstreak-v1 cache exists
3. Check Network tab: static assets should show "(ServiceWorker)" on repeat visits
4. API calls should NOT show ServiceWorker (always hit network)
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
All verification happens in Task 3 checkpoint.
</verification>

<success_criteria>
- beforeinstallprompt fires on Chrome/Edge (install icon visible)
- iOS Safari walkthrough still works (no regression)
- Lighthouse shows installable PWA
- Docker build includes sw.js and offline page
- Offline page displays correctly when network unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/16-service-worker-offline-support/16-04-SUMMARY.md`
</output>
