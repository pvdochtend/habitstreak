---
phase: 13-install-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/api/user/route.ts
  - src/contexts/pwa-install-context.tsx
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "GET /api/user returns installPromptDismissed and pwaInstalled fields"
    - "PATCH /api/user accepts installPromptDismissed and pwaInstalled updates"
    - "App captures beforeinstallprompt event before any page components mount"
    - "App correctly identifies iOS Safari vs Chromium browsers"
    - "App correctly detects standalone/PWA mode (already installed)"
    - "Dismissal state persists in localStorage immediately and syncs to database"
    - "usePwaInstall hook is available for consuming components"
  artifacts:
    - path: "src/app/api/user/route.ts"
      provides: "PWA field CRUD"
      contains: "installPromptDismissed"
    - path: "src/contexts/pwa-install-context.tsx"
      provides: "PWA install context provider and hook"
      exports: ["PwaInstallProvider", "usePwaInstall"]
    - path: "src/app/layout.tsx"
      provides: "Root layout with PWA provider"
      contains: "PwaInstallProvider"
  key_links:
    - from: "src/contexts/pwa-install-context.tsx"
      to: "/api/user"
      via: "fetch for dismissal sync"
      pattern: "fetch.*api/user"
    - from: "src/app/layout.tsx"
      to: "src/contexts/pwa-install-context.tsx"
      via: "provider wrapper"
      pattern: "PwaInstallProvider"
---

<objective>
Build the PWA install infrastructure: API endpoints, context provider, and root layout integration.

Purpose: Enable Phases 14-15 to consume PWA install state through a simple hook, without worrying about browser event timing, platform detection, or persistence.
Output: Working `usePwaInstall` hook that exposes platform, canInstall, isStandalone, isDismissed, triggerInstall(), and dismiss().
</objective>

<execution_context>
@/home/pvdochtend/.claude/get-shit-done/workflows/execute-plan.md
@/home/pvdochtend/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-install-infrastructure/13-CONTEXT.md
@.planning/phases/13-install-infrastructure/13-RESEARCH.md
@.planning/phases/13-install-infrastructure/13-01-SUMMARY.md

@src/app/api/user/route.ts
@src/contexts/theme-context.tsx
@src/app/layout.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend /api/user for PWA fields</name>
  <files>src/app/api/user/route.ts</files>
  <action>
Update the /api/user route to handle PWA-related fields:

**GET handler:**
Add to the `select` object:
```typescript
installPromptDismissed: true,
pwaInstalled: true,
```

**PATCH handler:**
Extend the Zod schema:
```typescript
installPromptDismissed: z
  .boolean({ errorMap: () => ({ message: 'installPromptDismissed moet true of false zijn' }) })
  .optional(),
pwaInstalled: z
  .boolean({ errorMap: () => ({ message: 'pwaInstalled moet true of false zijn' }) })
  .optional(),
```

Add to the updateData building:
```typescript
if (installPromptDismissed !== undefined) updateData.installPromptDismissed = installPromptDismissed
if (pwaInstalled !== undefined) updateData.pwaInstalled = pwaInstalled
```

Update the select in the update call to include the new fields.

Destructure the new fields from validation.data alongside existing fields.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Login and test GET: `curl -b cookies.txt http://localhost:3000/api/user` - should include installPromptDismissed and pwaInstalled
3. Test PATCH: `curl -X PATCH -b cookies.txt -H "Content-Type: application/json" -d '{"installPromptDismissed": true}' http://localhost:3000/api/user` - should succeed
  </verify>
  <done>
- GET /api/user returns installPromptDismissed (boolean)
- GET /api/user returns pwaInstalled (boolean)
- PATCH /api/user accepts installPromptDismissed
- PATCH /api/user accepts pwaInstalled
- Validation errors return Dutch messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PwaInstallProvider context</name>
  <files>src/contexts/pwa-install-context.tsx</files>
  <action>
Create a new file `src/contexts/pwa-install-context.tsx` following the ThemeProvider pattern.

**Core functionality:**

1. **Platform detection** (`detectPwaPlatform()`):
   - Return 'ios' for iOS Safari (handle iPad with desktop UA via maxTouchPoints)
   - Return 'chromium' for Chrome/Edge/Opera/Samsung Browser
   - Return 'unsupported' for Firefox, desktop Safari, iOS non-Safari browsers
   - Check for CriOS/FxiOS/OPiOS/EdgiOS to exclude iOS in-app browsers

2. **Standalone detection** (`isStandalone()`):
   - Check `navigator.standalone === true` (iOS)
   - Check `matchMedia('(display-mode: standalone)').matches`
   - Check `matchMedia('(display-mode: minimal-ui)').matches`

3. **Event capture**:
   - Listen for `beforeinstallprompt` in useEffect on mount
   - Call `e.preventDefault()` and store event reference in state
   - Listen for `appinstalled` to update state

4. **Dismissal persistence**:
   - localStorage key: `habitstreak-pwa-dismissed`
   - On mount: check localStorage, then fetch from /api/user for authoritative state
   - On dismiss: set localStorage immediately, then PATCH to /api/user
   - Handle unauthenticated users gracefully (localStorage-only)

5. **Context value**:
   ```typescript
   {
     platform: PwaPlatform
     isStandalone: boolean
     canInstall: boolean  // deferredPrompt exists OR (iOS && !dismissed && !standalone)
     isDismissed: boolean
     isLoading: boolean
     triggerInstall: () => Promise<{ outcome: 'accepted' | 'dismissed' } | null>
     dismiss: () => Promise<void>
   }
   ```

6. **triggerInstall():**
   - For Chromium: call `deferredPrompt.prompt()`, clear prompt after, return outcome
   - For iOS: return null (UI layer shows walkthrough modal instead)
   - Clear prompt reference after use (can only be called once)

**Important implementation notes:**
- Use 'use client' directive
- Import types from @/types (BeforeInstallPromptEvent, PwaPlatform)
- Handle SSR gracefully (typeof window === 'undefined' checks)
- Export both PwaInstallProvider and usePwaInstall hook
- Throw error if usePwaInstall called outside provider
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Import works: Add temporary `import { usePwaInstall } from '@/contexts/pwa-install-context'` to a page
3. No console errors on page load in dev mode
  </verify>
  <done>
- PwaInstallProvider captures beforeinstallprompt event on mount
- detectPwaPlatform correctly identifies iOS Safari, Chromium, and unsupported
- isStandalone correctly detects PWA mode on iOS and Chromium
- Dismissal persists to localStorage immediately
- Dismissal syncs to database for logged-in users
- usePwaInstall hook exposes all required state and methods
- Context handles SSR without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate provider in root layout</name>
  <files>src/app/layout.tsx</files>
  <action>
Update `src/app/layout.tsx` to wrap the app with PwaInstallProvider:

1. Import PwaInstallProvider:
   ```typescript
   import { PwaInstallProvider } from '@/contexts/pwa-install-context'
   ```

2. Wrap children inside ThemeProvider:
   ```tsx
   <ThemeProvider>
     <PwaInstallProvider>
       {children}
     </PwaInstallProvider>
   </ThemeProvider>
   ```

The nesting order matters: PwaInstallProvider inside ThemeProvider follows the existing pattern of having specialized providers nested within general ones.
  </action>
  <verify>
1. `npm run dev` starts without errors
2. Visit any page - no console errors
3. Open React DevTools and verify PwaInstallProvider appears in component tree at root
4. `npm run build` completes without errors
  </verify>
  <done>
- Root layout imports PwaInstallProvider
- PwaInstallProvider wraps app inside ThemeProvider
- App loads without errors in dev and production builds
- beforeinstallprompt event is captured before any page-specific components mount
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` - app starts without errors
2. `npm run build` - production build succeeds
3. `npm test` - all existing tests pass
4. Visit app on mobile device or emulator:
   - Chrome Android: Should detect as 'chromium' platform
   - Safari iOS: Should detect as 'ios' platform
   - Installed PWA: Should detect as standalone mode
5. Dismiss banner (when UI exists) and verify localStorage has `habitstreak-pwa-dismissed: "true"`
</verification>

<success_criteria>
- API returns and accepts PWA fields without breaking existing functionality
- Context provider captures beforeinstallprompt event reliably
- Platform detection correctly identifies iOS Safari, Chromium, and standalone mode
- Dismissal state persists across page refreshes (localStorage) and devices (database)
- usePwaInstall hook is ready for Phase 14-15 UI components to consume
- No TypeScript errors, no console errors, builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-install-infrastructure/13-02-SUMMARY.md`
</output>
