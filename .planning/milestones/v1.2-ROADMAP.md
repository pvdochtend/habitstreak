# Milestone v1.2: Auth.js v5 Migration

**Status:** ✅ SHIPPED 2026-01-23
**Phases:** 9
**Total Plans:** 2

## Overview

**Milestone Goal:** Enable dynamic URL detection so login works on localhost, LAN IPs, and custom domains without config changes.

This milestone migrated the authentication stack from NextAuth v4 to Auth.js v5, enabling `trustHost` support for automatic URL detection from the Host header. This eliminates the need for hardcoded `NEXTAUTH_URL` configuration, making self-hosting significantly easier (users can access on localhost, 127.0.0.1, LAN IPs, or custom domains without any auth config changes).

## Phases

### Phase 9: Auth.js v5 Migration

**Goal**: Migrate NextAuth v4 to Auth.js v5 with trustHost support
**Depends on**: Phase 8 (v1.1 complete)
**Plans**: 2 plans in 2 waves
**Completed**: 2026-01-23

**Requirements**: AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05, AUTH-06, AUTH-07, AUTH-08, URL-01, URL-02, URL-03, URL-04, URL-05, URL-06

**Success Criteria:**
1. User can log in via localhost:3000 and session persists ✓
2. User can log in via 127.0.0.1:3000 and session persists ✓
3. User can log in via LAN IP address and session persists ✓
4. User can log in via custom domain (if configured) and session persists ✓
5. All existing auth functionality works (login, logout, protected routes) ✓

Plans:

- [x] 09-01: Package + Configuration (wave 1)
  - Install next-auth@5.0.0-beta.30
  - Create edge-compatible auth.config.ts with trustHost: true
  - Rewrite auth.ts with v5 export pattern (handlers, auth, signIn, signOut)
  - Update TypeScript type declarations for v5 compatibility
  - Update environment variable documentation (AUTH_SECRET, AUTH_TRUST_HOST)

- [x] 09-02: Integration + Verification (wave 2)
  - Simplify API route to 3-line handlers re-export
  - Rewrite middleware using NextAuth(authConfig) pattern
  - Update auth-helpers.ts to use auth() function instead of getServerSession()
  - Verify TypeScript and Next.js build passes
  - Human verification: Multi-URL login testing

**Details:**

**Research:** Complete - See `.planning/research/authjs-v5-migration.md`

**Wave Execution:**
- Wave 1 (09-01): Package installation and configuration (5 min)
- Wave 2 (09-02): Integration and verification (8 min)

**Git Range:** `027194f` (upgrade to next-auth@beta) → `2dace40` (complete Integration plan)

**Files Modified:** 18 files (+563 insertions / -411 deletions)

**Key Artifacts Created:**
- `src/lib/auth.config.ts` - Edge-compatible auth config with trustHost
- Migrated `src/lib/auth.ts` - v5 export pattern
- Updated `src/middleware.ts` - v5 middleware pattern
- Updated `src/lib/auth-helpers.ts` - auth() function pattern
- Updated `src/types/next-auth.d.ts` - v5 type declarations

---

## Milestone Summary

**Decimal Phases:** None (milestone completed in single phase)

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| trustHost: true | Enables dynamic URL detection from Host header, eliminating hardcoded NEXTAUTH_URL | ✓ Good — Self-hosting works on any URL |
| Split config pattern | auth.config.ts (edge-compatible, no DB) + auth.ts (full config with DB) | ✓ Good — Proper v5 architecture |
| Handlers export pattern | Simplified API route to 3-line re-export, all config in auth.ts | ✓ Good — Single source of truth |
| auth() function pattern | Replaces getServerSession(authOptions) with simpler auth() call | ✓ Good — Cleaner v5 API |
| Preserve rate limiting | All existing IP/email-based rate limiting and account lockout logic maintained | ✓ Good — Zero regression |

**Issues Resolved:**

- Fixed NextAuth v4 limitation preventing dynamic URL detection
- Eliminated need for manual NEXTAUTH_URL configuration per deployment
- Resolved login issues when accessing via IP addresses or custom domains
- Fixed environment variable configuration (AUTH_SECRET, AUTH_TRUST_HOST)

**Issues Deferred:**

- Cookie migration from v4 to v5 — Complexity not worth it for small user base; users re-login once after upgrade (acceptable)
- OAuth providers — Credentials-only auth sufficient for personal self-hosted app
- E2E test automation for multi-URL auth — Manual verification sufficient; E2E test infrastructure deferred
- Reverse proxy configuration guide — Code enables capability; actual nginx/traefik setup is deployment-specific

**Technical Debt Incurred:** None

**Known Behaviors:**

- **Dev environment cookie collision** (Multi-port on localhost): When running both dev (port 3000) and container (port 3001) simultaneously, browsers share Auth.js session cookies across both ports, causing "user not found" errors when switching. This is expected browser behavior (not a bug). Workarounds: use different domains (localhost vs 127.0.0.1), stop one instance before starting the other, or clear cookies when switching. Does not affect production deployment.

---

_For current project status, see .planning/ROADMAP.md_
