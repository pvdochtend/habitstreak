# Milestone v1.1: Self-Hosting & Polish

**Status:** ✅ SHIPPED 2026-01-19
**Phases:** 6-8
**Total Plans:** 5

## Overview

HabitStreak v1.1 delivers self-hosting capability via Docker, fixes the streak calculation edge case with weekend/weekday tasks, and polishes the flame animation visibility. Three focused phases enable incremental deployment: Docker infrastructure first (unblocks self-hosting), then streak logic fix (core functionality), and finally visual polish (user delight).

## Phases

### Phase 6: Docker Deployment

**Goal**: App runs in Docker containers for self-hosting
**Depends on**: Nothing (first phase of v1.1)
**Requirements**: DOCKER-01, DOCKER-02, DOCKER-03, DOCKER-04, DOCKER-05, DOCKER-06
**Plans**: 3 plans in 3 waves

Plans:
- [x] 06-01: Foundation (standalone config, health endpoint, .dockerignore) — Wave 1
- [x] 06-02: Docker Files (Dockerfile, docker-compose, env template) — Wave 2
- [x] 06-03: Verification & Docs (local test, Synology docs) — Wave 3 [checkpoint]

**Details:**
- Next.js standalone output reduces Docker image from 1GB+ to 351MB
- Multi-stage Dockerfile with deps, builder, and runner stages
- Production docker-compose orchestrates app and PostgreSQL with health checks
- Health endpoint `/api/health` for container orchestration (public, no DB checks)
- Environment template with secure credential generation instructions
- Comprehensive Synology NAS deployment documentation (201 lines)
- Both Container Manager (GUI) and SSH (CLI) deployment options documented
- End-to-end deployment tested: signup → login → task creation

**Key Decisions:**
- Use Next.js standalone output to reduce image size
- Health endpoint design: public, no database checks for fast polling
- Include openssl package in Alpine images for Prisma compatibility
- Selective Prisma copying: only .prisma, @prisma, prisma packages
- Run migrations at container startup before starting server
- Use node_modules/prisma/build/index.js for Prisma CLI in standalone build
- Health check uses 127.0.0.1 instead of localhost for Alpine IPv6 compatibility

**Completed:** 2026-01-19

---

### Phase 7: Streak Calculation Fix

**Goal**: Streaks calculate correctly when scheduledCount < dailyTarget
**Depends on**: Phase 6 (can be developed independently)
**Requirements**: STREAK-01, STREAK-02, STREAK-03, STREAK-04
**Plans**: 1 plan in 1 wave

Plans:
- [x] 07-01: Streak Calculation Fix (TDD) — Wave 1

**Details:**
- Fixed critical bug where days with fewer scheduled tasks than dailyTarget incorrectly broke streaks
- Implemented isDaySuccessful() pure function using effectiveTarget = min(dailyTarget, scheduledCount) formula
- Applied fix consistently across all 4 locations (2 streak functions, 2 API routes)
- Comprehensive unit tests covering 13 test cases including edge cases and schedule preset scenarios
- Users with WORKWEEK tasks now correctly maintain streaks on weekends when completing all scheduled ALL_WEEK tasks

**Key Decisions:**
- Extract isDaySuccessful as pure function for testability and single source of truth
- Use effectiveTarget = min(dailyTarget, scheduledCount) formula to allow success on low-scheduled days
- Return false for scheduledCount === 0, caller skips with continue

**Completed:** 2026-01-19

---

### Phase 8: Animation Polish

**Goal**: Flame animation is clearly visible on mobile
**Depends on**: Phase 7 (can be developed independently)
**Requirements**: ANIM-01, ANIM-02, ANIM-03
**Plans**: 1 plan in 1 wave

Plans:
- [x] 08-01: Animation Polish (flame visibility, blink fix) — Wave 1 [checkpoint]

**Details:**
- Increased flame animation visibility with enhanced glow (50-80% opacity, 4-10px blur)
- Increased flameFlicker scale range (0.9-1.15) and rotation (±4deg) for more dynamic motion
- Added y-translate for dancing effect
- Fixed visual blink on task completion by preventing animation re-trigger on data refresh (hasMounted ref)
- Fixed dialog positioning bug using React Portal to bypass PageTransition transform constraints
- All animations respect prefers-reduced-motion

**Key Decisions:**
- Animation-only-on-mount: Use hasMounted ref to prevent slide-up re-triggering on data refresh
- Dialog portal rendering: Use createPortal to bypass PageTransition transform constraints

**Completed:** 2026-01-19

---

## Milestone Summary

**Key Decisions:**
- Docker standalone output (Rationale: Reduce image from 1GB+ to ~200MB)
- Pure function extraction for isDaySuccessful (Rationale: Testability and single source of truth)
- effectiveTarget formula (Rationale: Allow success when completing all scheduled tasks)
- Portal-based dialog rendering (Rationale: Fix positioning with CSS transforms)

**Issues Resolved:**
- Streak calculation incorrect for weekend with weekday-only tasks
- Flame animation too subtle on mobile screens
- Visual blink on task completion from animation re-trigger
- Dialog positioning broken by PageTransition transform
- Docker health checks failing with localhost on Alpine Linux

**Technical Decisions:**
- Image size 351MB vs 300MB target (acceptable for Next.js+Prisma)
- Prisma CLI path: node_modules/prisma/build/index.js for standalone builds
- Health check IP: 127.0.0.1 for Alpine wget IPv6 compatibility

---

_For current project status, see .planning/PROJECT.md_
